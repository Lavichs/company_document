<!doctype html>
<html lang="ru">

<head>
    <meta charset="utf-8" />
    <title>—Å—Å—ã–ª–∫–∏ –Ω–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ –†–ú–ò–°</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <style>
        .card-deck {
            flex-flow: row wrap;
        }

        .container {
            font-size: 0.75rem;
        }

        .small {
            font-family: 'Montserrat', sans-serif;
            font-size: 72%;
        }

        /* overlay –ø—Ä–∏ drag-and-drop */
        #drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.55);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 2rem;
            font-family: 'Montserrat', sans-serif;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <div id="data-item" class="row" data="{{ page_id }}">
            <div class="col-sm-12 col-xl-10 offset-xl-1">
                <h3 class="my-1 py-1 text-center"><i>{{ page }}</i></h3>

                {% for items in lists %}
                <div clas="row">
                    <div class="card-deck mb-2">
                        {% for item in items %}

                        {% if item.obj_type == 'file' %}
                        <div class="card col-sm-2 px-0 mx-1 ">
                            <a href="/admin/{{ item.id }}">
                                <img class="card-img-top pt-3" src="{{ item.image }}" alt="Card image cap"></a>
                            <div class="card-body px-1 pt-1 pb-0">
                                <p class="card-title text-center d-flex justify-content-center align-items-center">
                                    <i class="mr-2">{{ item.title }}</i>
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                                        onclick="showRenameForm('{{ item.id }}', '{{ item.title }}')"
                                        title="–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å">
                                        ‚úè
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                                        onclick="showChangeImage('{{ item.id }}')" title="–ò–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                                        üñº
                                    </button>
                                </p>
                                <div id="rename-form-{{ item.id }}" style="display:none;" class="mt-1 p-1">
                                    <input type="text" id="rename-input-{{ item.id }}"
                                        class="form-control form-control-sm mb-1">
                                    <div class="d-flex">
                                        <button onclick="saveRename('{{ item.id }}')"
                                            class="btn btn-success btn-sm w-50 mr-1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                        <button onclick="cancelRename('{{ item.id }}')"
                                            class="btn btn-secondary btn-sm w-50">–û—Ç–º–µ–Ω–∞</button>
                                    </div>
                                </div>
                                <div id="changeimg-form-{{ item.id }}" style="display:none;" class="mt-1 p-1">
                                    <input type="file" class="form-control form-control-sm mb-2"
                                        id="changeimg-input-{{ item.id }}">
                                    <div class="d-flex">
                                        <button onclick="saveChangeImg('{{ item.id }}')"
                                            class="btn btn-success btn-sm w-50 mr-1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                        <button onclick="cancelChangeImg('{{ item.id }}')"
                                            class="btn btn-secondary btn-sm w-50">–û—Ç–º–µ–Ω–∞</button>
                                    </div>
                                </div>
                                <p class="card-text text-center large  px-6 pb-4"></p>
                            </div>
                            <div class="card-footer px-1 py-1 d-flex flex-row">
                                <a href="/admin/{{ item.id }}" class="btn btn-info btn-sm w-50 mr-1">–ü–µ—Ä–µ–π—Ç–∏</a>
                                <button onclick="delete_object(event.target)" data="{{ item.id }}"
                                    class="btn btn-danger btn-sm w-50">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                        {% else %}
                        {% if item.obj_type == 'folder' %}
                        <div class="card col-sm-2 px-0 mx-1 ">
                            <a href="/admin/{{ item.id }}">
                                <img class="card-img-top pt-3" src="{{ item.image }}" alt="Card image cap"></a>
                            <div class="card-body px-1 pt-1 pb-0">
                                <p class="card-title text-center d-flex justify-content-center align-items-center">
                                    <i class="mr-2">{{ item.title }}</i>
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                                        onclick="showRenameForm('{{ item.id }}', '{{ item.title }}')">
                                        ‚úè
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                                        onclick="showChangeImage('{{ item.id }}')" title="–ò–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                                        üñº
                                    </button>
                                </p>
                                <div id="rename-form-{{ item.id }}" style="display:none;" class="mt-1 p-1">
                                    <input type="text" id="rename-input-{{ item.id }}"
                                        class="form-control form-control-sm mb-1">
                                    <div class="d-flex">
                                        <button onclick="saveRename('{{ item.id }}')"
                                            class="btn btn-success btn-sm w-50 mr-1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                        <button onclick="cancelRename('{{ item.id }}')"
                                            class="btn btn-secondary btn-sm w-50">–û—Ç–º–µ–Ω–∞</button>
                                    </div>
                                </div>
                                <div id="changeimg-form-{{ item.id }}" style="display:none;" class="mt-1 p-1">
                                    <input type="file" class="form-control form-control-sm mb-2"
                                        id="changeimg-input-{{ item.id }}">
                                    <div class="d-flex">
                                        <button onclick="saveChangeImg('{{ item.id }}')"
                                            class="btn btn-success btn-sm w-50 mr-1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                        <button onclick="cancelChangeImg('{{ item.id }}')"
                                            class="btn btn-secondary btn-sm w-50">–û—Ç–º–µ–Ω–∞</button>
                                    </div>
                                </div>
                                <p class="card-text text-center large  px-6 pb-4"></p>
                            </div>
                            <div class="card-footer px-1 py-1 d-flex flex-row">
                                <a href="/admin/{{ item.id }}" class="btn btn-info btn-sm w-50 mr-1">–ü–µ—Ä–µ–π—Ç–∏</a>
                                <button onclick="delete_object(event.target)" data="{{ item.id }}"
                                    class="btn btn-danger btn-sm w-50">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                        {% else %}
                        <div class="card col-sm-2 px-0 mx-1 ">
                            <a href="{{ item.href }}">
                                <img class="card-img-top pt-3" src="{{ item.image }}" alt="Card image cap"></a>
                            <div class="card-body px-1 pt-1 pb-0">
                                <p class="card-title text-center d-flex justify-content-center align-items-center">
                                    <i class="mr-2">{{ item.title }}</i>
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                                        onclick="showRenameForm('{{ item.id }}', '{{ item.title }}')">
                                        ‚úè
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1"
                                        onclick="showChangeImage('{{ item.id }}')" title="–ò–∑–º–µ–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ">
                                        üñº
                                    </button>
                                </p>
                                <div id="rename-form-{{ item.id }}" style="display:none;" class="mt-1 p-1">
                                    <input type="text" id="rename-input-{{ item.id }}"
                                        class="form-control form-control-sm mb-1">
                                    <div class="d-flex">
                                        <button onclick="saveRename('{{ item.id }}')"
                                            class="btn btn-success btn-sm w-50 mr-1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                        <button onclick="cancelRename('{{ item.id }}')"
                                            class="btn btn-secondary btn-sm w-50">–û—Ç–º–µ–Ω–∞</button>
                                    </div>
                                </div>
                                <div id="changeimg-form-{{ item.id }}" style="display:none;" class="mt-1 p-1">
                                    <input type="file" class="form-control form-control-sm mb-2"
                                        id="changeimg-input-{{ item.id }}">
                                    <div class="d-flex">
                                        <button onclick="saveChangeImg('{{ item.id }}')"
                                            class="btn btn-success btn-sm w-50 mr-1">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                                        <button onclick="cancelChangeImg('{{ item.id }}')"
                                            class="btn btn-secondary btn-sm w-50">–û—Ç–º–µ–Ω–∞</button>
                                    </div>
                                </div>
                                <p class="card-text text-center large  px-6 pb-4"></p>
                            </div>
                            <div class="card-footer px-1 py-1 d-flex flex-row">
                                <a href="{{ item.href }}" class="btn btn-info btn-sm w-50 mr-1">–ü–µ—Ä–µ–π—Ç–∏</a>
                                <button onclick="delete_object(event.target)" data="{{ item.id }}"
                                    class="btn btn-danger btn-sm w-50">–£–¥–∞–ª–∏—Ç—å</button>
                            </div>
                        </div>
                        {% endif %}
                        {% endif %}

                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
                <div clas="row">
                    <div class="card-deck mb-2">
                        <div class="card col-sm-2 px-0 mx-1" id="add-card">
                            <img class="card-img-top pt-3 p-3" style="cursor: pointer;"
                                src="/resource/images/plus_2.png" alt="Card image cap">
                            <div class="card-body px-1 pt-1 pb-0">
                                <p class="card-title text-center"><i></i></p>
                                <p class="card-text text-center large  px-6 pb-4"></p>
                            </div>
                            <div class="card-footer px-1 py-1">
                                <button href="." class="btn btn-secondary btn-sm w-100 ">–î–æ–±–∞–≤–∏—Ç—å</button>
                            </div>
                        </div>

                        <!-- –í—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏—è -->
                        <div id="add-options" class="card col-sm-2 px-0 mx-1" style="display:none;">
                            <div class="card-body d-flex flex-column justify-content-around">
                                <button class="btn btn-primary btn-sm w-100 mb-3" id="add-dir-btn">–°–æ–∑–¥–∞—Ç—å
                                    –ø–∞–ø–∫—É</button>
                                <button class="btn btn-secondary btn-sm w-100 mb-3" id="add-file-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å
                                    —Ñ–∞–π–ª(—ã)</button>
                                <button class="btn btn-secondary btn-sm w-100" id="add-link-btn">–î–æ–±–∞–≤–∏—Ç—å
                                    —Å—Å—ã–ª–∫—É</button>
                            </div>
                        </div>

                        <!-- –§–æ—Ä–º–∞: —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é -->
                        <div id="add-dir-form" class="card col-sm-6 px-0 mx-1" style="display:none;">
                            <!-- style="display:none;" -->
                            <div class="card-body d-flex flex-column justify-content-around">
                                <input type="text" class="form-control mb-2" id="dir-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–∞–ø–∫–∏">
                                <button class="btn btn-success" id="save-dir-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                            </div>
                        </div>

                        <!-- –§–æ—Ä–º–∞: –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã -->
                        <div id="add-file-form" class="card col-sm-6 px-0 mx-1" style="display:none;">
                            <div class="card-body d-flex flex-column justify-content-around">
                                <input type="file" class="form-control mb-2" id="file-input" multiple>
                                <button class="btn btn-success" id="save-file-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                            </div>
                        </div>

                        <!-- –§–æ—Ä–º–∞: —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É -->
                        <div id="add-link-form" class="card col-sm-6 px-0 mx-1" style="display:none;">
                            <div class="card-body d-flex flex-column justify-content-around">
                                <input type="text" class="form-control mb-2" id="link-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                                <input type="text" class="form-control mb-2" id="link-href" placeholder="–°—Å—ã–ª–∫–∞">
                                <input type="file" class="form-control mb-2" id="link-input">
                                <button class="btn btn-success" id="save-link-btn">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="drop-overlay">
        <div>
            <img src="/resource/images/upload.png" style="width:150px; opacity:0.9;">
            <div class="text-center mt-3">–û—Ç–ø—É—Å—Ç–∏—Ç–µ —Ñ–∞–π–ª(—ã) –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
        </div>
    </div>


    <script>
        idr = document.getElementById('data-item').getAttribute('data')

        // –ø–æ–∫–∞–∑–∞—Ç—å –≤—ã–±–æ—Ä –¥–µ–π—Å—Ç–≤–∏–π
        document.getElementById("add-card").onclick = function () {
            document.getElementById("add-options").style.display = "block";
        };

        // –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É "–¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è"
        document.getElementById("add-dir-btn").onclick = function () {
            document.getElementById("add-dir-form").style.display = "block";
            document.getElementById("add-file-form").style.display = "none";
            document.getElementById("add-link-form").style.display = "none";
        };

        // –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É "—Ñ–∞–π–ª"
        document.getElementById("add-file-btn").onclick = function () {
            document.getElementById("add-file-form").style.display = "block";
            document.getElementById("add-dir-form").style.display = "none";
            document.getElementById("add-link-form").style.display = "none";
        };

        // –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É "—Å—Å—ã–ª–∫–∞"
        document.getElementById("add-link-btn").onclick = function () {
            document.getElementById("add-link-form").style.display = "block";
            document.getElementById("add-dir-form").style.display = "none";
            document.getElementById("add-file-form").style.display = "none";
        };

        // –æ—Ç–ø—Ä–∞–≤–∫–∞: —Å–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
        document.getElementById("save-dir-btn").onclick = async function () {
            const name = document.getElementById("dir-name").value;

            const resp = await fetch(`/${idr}/add_folder`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title: name })
            });

            if (resp.ok) window.location.reload()
            else alert("–û—à–∏–±–∫–∞: " + resp.status);
        };

        // –æ—Ç–ø—Ä–∞–≤–∫–∞: –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã
        document.getElementById("save-file-btn").onclick = async function () {
            const files = document.getElementById("file-input").files;
            parent_id = document.getElementById("data-item").getAttribute('data')

            const formData = new FormData();
            for (let f of files) formData.append("files", f);

            const resp = await fetch(`/${parent_id}/add_file`, {
                method: "POST",
                body: formData
            });

            const resp_data = await resp.json()

            if (resp.ok) window.location.reload()
            else alert("–û—à–∏–±–∫–∞: " + resp_data.detail);
        };

        // –æ—Ç–ø—Ä–∞–≤–∫–∞: –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Å—ã–ª–∫—É
        document.getElementById("save-link-btn").onclick = async function () {
            const files = document.getElementById("link-input").files;
            parent_id = document.getElementById("data-item").getAttribute('data')

            const formData = new FormData();
            for (let f of files) formData.append("files", f);

            const name = document.getElementById("link-name").value;
            const href = document.getElementById("link-href").value;

            let resp = await fetch(`/${parent_id}/add_link`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    title: name,
                    obj_type: 'link',
                    href: href
                })
            });

            let dta = await resp.json()
            let data = dta.data
            console.log(data)

            resp = await fetch(`/${data.id}/change_image`, {
                method: "POST",
                body: formData
            });

            dta = await resp.json()
            data = dta.data
            console.log(data)

            if (resp.ok) window.location.reload()
            else alert("–û—à–∏–±–∫–∞: " + resp.status);
        };

        async function delete_object(e) {
            console.log(e.getAttribute('data'))

            const resp = await fetch(`/${e.getAttribute('data')}`, {
                method: "DELETE"
            })

            if (resp.ok) window.location.reload()
            else alert("–û—à–∏–±–∫–∞: " + resp.status);
        }

        // ================= DRAG & DROP –ù–ê –í–ï–°–¨ –≠–ö–†–ê–ù ================= //

        const dropOverlay = document.getElementById("drop-overlay");
        const fileInput = document.getElementById("file-input");

        let dragCounter = 0;

        // –ø–æ–∫–∞–∑–∞—Ç—å overlay
        function showOverlay() {
            dropOverlay.style.display = "flex";
        }

        // —Å–∫—Ä—ã—Ç—å overlay
        function hideOverlay() {
            dropOverlay.style.display = "none";
        }

        // –ª–æ–≤–∏–º —Å–æ–±—ã—Ç–∏—è drag –Ω–∞ –≤–µ—Å—å –¥–æ–∫—É–º–µ–Ω—Ç
        document.addEventListener("dragenter", e => {
            e.preventDefault();
            dragCounter++;
            showOverlay();
        });

        document.addEventListener("dragleave", e => {
            e.preventDefault();
            dragCounter--;
            if (dragCounter <= 0) hideOverlay();
        });

        document.addEventListener("dragover", e => {
            e.preventDefault();  // –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ
        });

        // –ø—Ä–∏ drop ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏
        document.addEventListener("drop", e => {
            e.preventDefault();
            dragCounter = 0;
            hideOverlay();

            const dt = e.dataTransfer;
            const files = dt.files;

            if (files.length === 0) return;

            // –ø–æ–∫–∞–∑–∞—Ç—å —Ñ–æ—Ä–º—É –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
            document.getElementById("add-options").style.display = "none";
            document.getElementById("add-dir-form").style.display = "none";
            document.getElementById("add-file-form").style.display = "block";

            // –∑–∞—Å—É–Ω—É—Ç—å —Ñ–∞–π–ª—ã –≤ input
            fileInput.files = files;

            // alert(`–í—ã –≤—ã–±—Ä–∞–ª–∏ ${files.length} —Ñ–∞–π–ª(–æ–≤). –¢–µ–ø–µ—Ä—å –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–≥—Ä—É–∑–∏—Ç—å".`);
        });

        // ================== –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–ï ================== //

        function showRenameForm(id, currentTitle) {
            document.getElementById(`changeimg-form-${id}`).style.display = "none";
            const form = document.getElementById(`rename-form-${id}`);
            const input = document.getElementById(`rename-input-${id}`);
            input.value = currentTitle;
            form.style.display = "block";
        }

        function cancelRename(id) {
            document.getElementById(`rename-form-${id}`).style.display = "none";
        }

        async function saveRename(id) {
            const newTitle = document.getElementById(`rename-input-${id}`).value;

            const resp = await fetch(`/${id}/rename`, {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ title: newTitle })
            });

            if (resp.ok) {
                window.location.reload();
            } else {
                alert("–û—à–∏–±–∫–∞: " + resp.status);
            }
        }

        // ================== –ó–ê–ú–ï–ù–ê –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø ================== //

        function showChangeImage(id) {
            document.getElementById(`rename-form-${id}`).style.display = "none";
            const form = document.getElementById(`changeimg-form-${id}`);
            const input = document.getElementById(`changeimg-input-${id}`);
            // input.value = currentTitle;
            form.style.display = "block";
        }

        function cancelChangeImg(id) {
            document.getElementById(`changeimg-form-${id}`).style.display = "none";
        }

        async function saveChangeImg(id) {
            const files = document.getElementById(`changeimg-input-${id}`).files;

            const formData = new FormData();
            for (let f of files) formData.append("files", f);

            let resp = await fetch(`/${id}/change_image`, {
                method: "POST",
                body: formData
            });

            let dta = await resp.json()
            console.log(dta.data)

            if (resp.ok) window.location.reload()
            else alert("–û—à–∏–±–∫–∞: " + dta.detail);
        }


    </script>


</body>

</html>